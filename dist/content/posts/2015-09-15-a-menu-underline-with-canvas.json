{"content":"<p>A while back I set out to make an animated underline for a menu (check out the one on this page, which you&#39;ll see if you hover over a menu item). The goal was to have an underline under the active menu item that would animate over to any hovered menu item but return to the active menu item when menu items were unhovered. I first thought of doing this with CSS transitions, but I anticipated some issues with using a single underline element and having multiple transition states. I also wanted to include a clicking animation where the underline would bow/bend in the center when a menu item was clicked, and I didn&#39;t see this going down easily in CSS. Seeing as I eventually ditched the bending animation, CSS transitions may have been the way to go. Oh well! Below is a runthrough of how I went about doing this with <code>canvas</code> (including the clicking/bending animation). I used jQuery to make this a bit easier. A working demo can be seen <a href=\"http://codepen.io/benjanes/pen/PPqMaQ\">here</a>.</p>\n<h3 id=\"overview\">Overview</h3>\n<p>Here are the steps:</p>\n<ol>\n<li><a href=\"#html-and-css-set-up\">Set up a menu with a canvas absolutely positioned behind it.</a></li>\n<li><a href=\"#setting-up-raf-and-canvas\">Set up the canvas and rAF.</a></li>\n<li><a href=\"#link-business\">Get references to the links, make an empty array to store link measurements, find the index of the &#39;active&#39; menu link.</a></li>\n<li><a href=\"#underline-variables\">Prepare variables used to draw and update an underline on the canvas.</a></li>\n<li><a href=\"#create-event-handlers\">Create event handlers for hovering and clicking menu links.</a></li>\n<li><a href=\"#measure-links-and-set-underline\">Measure the links and store their x-coordinate and width, set initial position and width of the underline using the &#39;active&#39; menu link&#39;s measurements.</a></li>\n<li><a href=\"#drawing-and-updating-functions\">Set up the drawing and updating functions for the underline.</a></li>\n<li><a href=\"#animate-function\">Add an animate function.</a></li>\n<li><a href=\"#kick-things-off\">Set everything in motion &mdash; assign event handlers, call the measure and set functions, animate!</a></li>\n</ol>\n<h3 id=\"html-and-css-set-up\">HTML and CSS Set-up</h3>\n<p>Briefly, the menu is a relatively positioned <code>&lt;nav&gt;</code> element, and an absolutely positioned canvas element is nested within the <code>&lt;nav&gt;</code>. The canvas is set to <code>left: 0</code>, as drawing coordinates for the underline will be measured relative to the <code>&lt;nav&gt;</code>.</p>\n<h5 id=\"html\">HTML</h5>\n<pre><code>&lt;nav&gt;\n  &lt;a href=&quot;#&quot; class=&quot;menu-link active&quot;&gt;home&lt;/a&gt;\n  &lt;a href=&quot;#&quot; class=&quot;menu-link&quot;&gt;products&lt;/a&gt;\n  &lt;a href=&quot;#&quot; class=&quot;menu-link&quot;&gt;services&lt;/a&gt;\n  &lt;a href=&quot;#&quot; class=&quot;menu-link&quot;&gt;our philosophy&lt;/a&gt;\n  &lt;canvas id=&quot;underline&quot;&gt;&lt;/canvas&gt;\n&lt;/nav&gt;</code></pre>\n<h5 id=\"css\">CSS</h5>\n<pre><code>nav {\n  position: relative;\n}\n\n.menu-link {\n  text-decoration: none;\n  margin-right: 2em;\n  font-size: 1.2em;\n  color: #000;\n  font-family: Montserrat, Helvetica, Sans-Serif;\n}\n\n.menu-link:hover {\n  color: red;\n}\n\ncanvas {\n  position: absolute;\n  left: 0;\n  z-index: -1;\n}</code></pre>\n<h3 id=\"setting-up-raf-and-canvas\">Setting up rAF and Canvas</h3>\n<p>The animation is done using requestAnimationFrame, which we&#39;ll want to grab a reference to for convenience. Before the canvas can be drawn on, we need to get a reference to it and get a 2d context. The width of the canvas is set equal to the width of the <code>&lt;nav&gt;</code> element, so that the underline has sufficient space to roam.</p>\n<pre><code>var requestAnimFrame, canvas, ctx;\n\n// a reference to rAF\nrequestAnimFrame =\n  window.requestAnimationFrame ||\n  window.webkitRequestAnimationFrame ||\n  window.mozRequestAnimationFrame ||\n  window.msRequestAnimationFrame ||\n  window.oRequestAnimationFrame ||\n  function(callback) {\n    return setTimeout(callback, 1);\n  };\n\ncanvas = document.getElementById(&#39;underline&#39;);\nctx = canvas.getContext(&#39;2d&#39;);\n// set the width of the canvas equal to the width of the nav element\ncanvas.width = $(&#39;nav&#39;).outerWidth();</code></pre>\n<h3 id=\"link-business\">Link Business</h3>\n<p>We&#39;ll next get a jQuery collection of the menu links, create an empty array to store measurements of those menu links, and create a variable to mark which menu link is currently active.</p>\n<pre><code>var $links, link_collection, currentIndex;\n\n// the links and an array to store their respective measurements\n$links = $(&#39;.menu-link&#39;);\nlink_collection = [];\n// the index of the currently active menu link\ncurrentIndex = $links.index( $(&#39;.active&#39;) );</code></pre>\n<h3 id=\"underline-variables\">Underline Variables</h3>\n<p>Several variables are used to draw the underline on the canvas. Updating these variables and redrawing the canvas will animate the underline.</p>\n<pre><code>var hoverIndex, ulineCurveStart, ulineCurveEnd, ulineX,\n    ulineWidth, ulineStroke;\n\n// vars to update when drawing the underline\nhoverIndex = currentIndex;\nulineCurveStart = 0;\nulineCurveEnd = 0;\nulineStroke = &#39;black&#39;;</code></pre>\n<p>The <code>hoverIndex</code> variable will be used in conjunction with the collection of link measurements (to be built out later) to grab a set of measurements corresponding to the hovered link and update the underline drawing. <code>ulineX</code> and <code>ulineWidth</code> are the variables that will actually be getting updated and fed into the drawing function. Likewise with <code>ulineCurveStart</code> and <code>ulineCurveEnd</code>, which describe the bounds of the underline&#39;s curvature. <code>ulineStroke</code> is simply the underline&#39;s color. These variables will make more sense once the drawing function is defined.</p>\n<h3 id=\"create-event-handlers\">Create Event Handlers</h3>\n<p>The hover and click events need to update the variables used to draw the underline in order for it to actually animate. We&#39;ll next add in the event handler functions.</p>\n<pre><code>var hoverOn, hoverOff, mouseDown, mouseUp;\n\n// Event handlers. Update vars used to draw the underline\nhoverOn = function() {\n  // update hoverIndex to the index of the hovered link, draw the\n  // underline in red\n  hoverIndex = $links.index($(this));\n  ulineStroke = &#39;red&#39;;\n};\n\nhoverOff = function() {\n  // revert the hoverIndex to the currently selected menu link,\n  // revert to black underline\n  hoverIndex = currentIndex;\n  ulineStroke = &#39;black&#39;;\n};\n\nmouseDown = function() {\n  // this is the curve offset; greater values give a greater curvature\n  // on click\n  ulineCurveEnd = 5;\n};\n\nmouseUp = function() {\n  // revert to a straight line, update the active menu item and update\n  // currentIndex to the index of the selected menu item\n  ulineCurveEnd = 0;\n  $links.removeClass(&#39;active&#39;);\n  $(this).addClass(&#39;active&#39;);\n  currentIndex = $links.index($(this));\n};</code></pre>\n<p>All that the hover functions are doing is updating <code>hoverIndex</code> and the stroke color for the underline. Again, <code>hoverIndex</code> will be used to access the collection of link measurements when updating the drawing variables (specifically <code>ulineX</code> and <code>ulineWidth</code>). The click functions update the curve variables and reset the active link.</p>\n<h3 id=\"measure-links-and-set-underline\">Measure Links and Set Underline</h3>\n<p>The menu links need to be measured in order to know where to position the underline and how wide to make it. To do this, we loop through <code>$links</code> and measure the <code>position.left</code> and <code>outerWidth</code> of each, then store this information at a new index in <code>link_collection</code>. Now when a link is hovered, accessing <code>link_collection[hoverIndex]</code> will tell us what the left drawing coordinate and width of the underline should be. Because the currently active menu link should be underlined be default (and the underline will animate back to this position when other links are un-hovered), <code>ulineX</code> and <code>ulineWidth</code> can be set using <code>currentIndex</code>.</p>\n<pre><code>var LinkMeasurement, measureLinks, setUnderline;\n\n// constructor for adding a link to the collection\nLinkMeasurement = function(x, width) {\n  this.x = x;\n  this.width = width;\n};\n\n// loop through the links and build out the collection of measurements\nmeasureLinks = function() {\n  $links.each( function(index) {\n    // the &#39;round&#39; lineCap combined with the lineWidth=3 on the\n    // underline makes it 3 px longer on either side, so add 3 to\n    // the left (x) coordinate to place the underline directly\n    // underneath the text\n    var x = $links.eq(index).position().left + 3;\n    // likewise, subtract 6 from the text width to put the underline\n    // right underneath the link text\n    var width = $links.eq(index).outerWidth() - 6;\n    // add these measurements to the collection of link measurements\n    link_collection[index] = new LinkMeasurement( x, width );\n  });\n};\n\n// set the underline measurements equal to the measurements for the\n// currently selected menu link\nsetUnderline = function() {\n  ulineX  = link_collection[currentIndex].x;\n  ulineWidth = link_collection[currentIndex].width;\n};</code></pre>\n<h3 id=\"drawing-and-updating-functions\">Drawing and Updating Functions</h3>\n<p>The drawing function that paints the underline to the canvas utilizes the variables that are getting switched around by the event handler functions. Every time that <code>drawUnderline</code> is called, the canvas is first cleared and <code>updateUnderline</code> is called to recalculate the drawing variables (if they need recalculation).</p>\n<pre><code>var drawUnderline, updateUnderline;\n\ndrawUnderline = function() {\n  ctx.beginPath();\n  // using round linecap and lineWidth = 3, adjust as desired...\n  // changing these may require updating measureLinks function\n  ctx.lineCap = &#39;round&#39;;\n  ctx.lineWidth = 3;\n  // x coordinate is variable ulineX, y coordinate can be adjusted to\n  // change height of underline relative to the menu links\n  ctx.moveTo( ulineX, 40 );\n  // using a curve to draw the underline in order to allow for the\n  // curvature animation on link click\n  ctx.bezierCurveTo( ulineX, 40 + ulineCurveStart, ulineX + ulineWidth, 40 + ulineCurveStart, ulineX + ulineWidth, 40 );\n  ctx.strokeStyle = ulineStroke;\n  ctx.stroke();\n};\n\nupdateUnderline = function() {\n  // update underline x position\n  if( ulineX !== link_collection[hoverIndex].x ) {\n\n    if( ulineX &lt; link_collection[hoverIndex].x ) {\n      // if the underline is left of where it should be, move it right\n      ulineX += (link_collection[hoverIndex].x - ulineX) / 10;\n    } else if( ulineX &gt; link_collection[hoverIndex].x ) {\n      // if underline is right of where it should be, move it left\n      ulineX -= (ulineX - link_collection[hoverIndex].x) / 10;\n    }\n\n  }\n\n  // update underline width\n  if( ulineWidth !== link_collection[hoverIndex].width ) {\n\n    if( ulineWidth &lt; link_collection[hoverIndex].width ) {\n      // if underline is narrower than it should be, widen it\n      ulineWidth += (link_collection[hoverIndex].width - ulineWidth) / 15;\n    } else if( ulineWidth &gt; link_collection[hoverIndex].width ) {\n      // if wider than it should be, narrow it\n      ulineWidth -= (ulineWidth - link_collection[hoverIndex].width) / 15;\n    }\n\n  }\n\n  // update underline curve\n  if( ulineCurveStart !== ulineCurveEnd ) {\n\n    if( ulineCurveStart &lt; ulineCurveEnd ) {\n      // bend the center of the underline down\n      ulineCurveStart += (ulineCurveEnd - ulineCurveStart) / 5;\n    } else if( ulineCurveStart &gt; ulineCurveEnd ) {\n      // straighten the underline\n      ulineCurveStart -= (ulineCurveStart - ulineCurveEnd) / 5;\n    }\n\n  }\n};</code></pre>\n<h3 id=\"animate-function\">Animate Function</h3>\n<p>The <code>animate</code> function uses the reference to <code>requestAnimationFrame</code> to call itself when it can. Three things are happening when <code>animate</code> gets called &mdash; the canvas is cleared out, the underline drawing variables are recalculated, and the underline is redrawn using the current drawing variables.</p>\n<pre><code>var animate;\n\nanimate = function(){\n  // clear out what is drawn already\n  ctx.clearRect( 0, 0, canvas.width, canvas.height );\n  // update variables and redraw\n  updateUnderline();\n  drawUnderline();\n\n  requestAnimFrame(function(){\n    animate();\n  });\n};</code></pre>\n<h3 id=\"kick-things-off\">Kick Things Off</h3>\n<p>Now that everything is in place, all that remains to be done is to assign the event handlers to <code>$links</code>, call <code>measureLinks</code> to collect measurements for the links on the page, call <code>setUnderline</code> to have the default underline position and width set to that of the &#39;active&#39; menu link, and set the underline in motion with <code>animate</code>.</p>\n<pre><code>// assign event handlers\n$links\n  .hover(hoverOn, hoverOff)\n  .on(&#39;mousedown&#39;, mouseDown)\n  .on(&#39;mouseup&#39;, mouseUp);\n\nmeasureLinks();\nsetUnderline();\nanimate();</code></pre>\n<h3 id=\"hold-up-loading-web-fonts\">Hold Up! Loading Web Fonts</h3>\n<p>The link text needs to be rendered before it can be measured. If you are using a web font for the links and <code>$(document).ready</code> to delay page scripts until after the content is ready, an initial rendering of unstyled text will occur and measurement will take place before the styled, web font text is in place. If your web font text has different character sizing/spacing than the unstyled text (and it almost definitely does), the measurements used to draw the underline will be off!</p>\n<p>Luckily, using Web Font Loader &mdash; a project jointly developed by Google and Typekit &mdash; makes watching for the loading of your web fonts really easy (check it out <a href=\"https://github.com/typekit/webfontloader\">here</a>).</p>\n<p>After referencing the Web Font Loader library, a callback function can be added when loading in a font that will fire when that font is active (<em>i.e.</em> when it has been applied to the page).</p>\n<h5 id=\"html\">HTML</h5>\n<pre><code>&lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js&quot;&gt;&lt;/script&gt;</code></pre>\n<h5 id=\"js\">JS</h5>\n<pre><code>var fontLoaded;\n\n// create a callback list\nfontLoaded = $.Callbacks();\n\n// add to the callback list... everything is dependent on measureLinks\n// having proper DOM measurements, and want to delay this until after\n// the font-face is rendered\nfontLoaded.add(function() {\n  measureLinks();\n  setUnderline();\n  animate();\n});\n\n// see github.com/typekit/webfontloader for more info on\n// Web Font Loader\nWebFont.load({\n\n  // using Montserrat font\n  google: {\n    families: [&#39;Montserrat:400&#39;]\n  },\n\n  // when Montserrat:400 is ready, fire the callback list\n  active: function(){\n    fontLoaded.fire();\n  }\n});</code></pre>","meta":{"year":"2015","month":"09","day":"15","filename":"a-menu-underline-with-canvas","title":"A Menu Underline with Canvas","date":"2015-09-15T12:00:00.000Z","desc":"Making an animated canvas menu underline","tags":["canvas","requestAnimationFrame","JavaScript","HTML5","animation"]}}